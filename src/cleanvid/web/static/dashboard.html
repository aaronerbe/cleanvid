<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanvid Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .pulse-green {
            animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-green {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .log-container {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Cleanvid Dashboard</h1>
                    <p class="text-blue-100">Automated Movie Profanity Filtering</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-blue-100">Last Updated</div>
                    <div id="lastUpdate" class="text-lg font-semibold">--:--:--</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- System Status -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4">System Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Container Status -->
                <div class="stat-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Container</p>
                            <p id="containerStatus" class="text-2xl font-bold text-green-600">‚óè</p>
                        </div>
                        <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                        </svg>
                    </div>
                </div>

                <!-- FFmpeg Status -->
                <div class="stat-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">FFmpeg</p>
                            <p id="ffmpegStatus" class="text-lg font-bold">Available</p>
                        </div>
                        <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- OpenSubtitles Status -->
                <div class="stat-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">OpenSubtitles</p>
                            <p id="subtitlesStatus" class="text-lg font-bold">Enabled</p>
                        </div>
                        <svg class="w-12 h-12 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Profanity Words -->
                <div class="stat-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Word List</p>
                            <p id="wordCount" class="text-2xl font-bold">--</p>
                        </div>
                        <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Processing Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="text-gray-500 text-sm">Total Videos</p>
                    <p id="totalVideos" class="text-3xl font-bold text-blue-600">--</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="text-gray-500 text-sm">Processed</p>
                    <p id="processedVideos" class="text-3xl font-bold text-green-600">--</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="text-gray-500 text-sm">Unprocessed</p>
                    <p id="unprocessedVideos" class="text-3xl font-bold text-yellow-600">--</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="text-gray-500 text-sm">Success Rate</p>
                    <p id="successRate" class="text-3xl font-bold text-purple-600">--%</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="text-gray-500 text-sm">Library Size</p>
                    <p id="totalSize" class="text-3xl font-bold text-indigo-600">-- GB</p>
                </div>
            </div>
        </section>

        <!-- Recent Activity & Failures -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Recent Activity -->
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Recent Activity</h2>
                    <button onclick="refreshHistory()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Refresh
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div id="recentActivity" class="divide-y max-h-96 overflow-y-auto">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Failed Videos -->
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Failed Videos</h2>
                    <button onclick="refreshFailures()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        Refresh
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div id="failedVideos" class="divide-y max-h-96 overflow-y-auto">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Process Video Section -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Process Video</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex gap-4">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search for video by name..." 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        onkeyup="searchVideos()"
                    />
                    <button onclick="processSelected()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        Process
                    </button>
                </div>
                <div id="searchResults" class="mt-4 max-h-60 overflow-y-auto">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="container mx-auto px-4 py-6 text-center">
            <p>Cleanvid Dashboard v1.0 | <a href="https://github.com" class="text-blue-400 hover:text-blue-300">GitHub</a></p>
        </div>
    </footer>

    <script>
        let selectedVideoPath = null;

        // Auto-refresh every 10 seconds
        setInterval(() => {
            refreshStatus();
            refreshStatistics();
            refreshHistory();
        }, 10000);

        // Initial load
        refreshStatus();
        refreshStatistics();
        refreshHistory();
        refreshFailures();

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update status displays
                document.getElementById('containerStatus').textContent = '‚óè';
                document.getElementById('containerStatus').className = 'text-2xl font-bold text-green-600 pulse-green';
                
                document.getElementById('ffmpegStatus').textContent = data.ffmpeg_available ? 'Available' : 'Not Available';
                document.getElementById('subtitlesStatus').textContent = data.opensubtitles_enabled ? 'Enabled' : 'Disabled';
                document.getElementById('wordCount').textContent = data.profanity_words || '--';
                
                document.getElementById('totalVideos').textContent = data.total_videos || '--';
                document.getElementById('processedVideos').textContent = data.processed_videos || '--';
                document.getElementById('unprocessedVideos').textContent = data.unprocessed_videos || '--';
                
                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('containerStatus').className = 'text-2xl font-bold text-red-600';
            }
        }

        async function refreshStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const data = await response.json();
                
                const fileStats = data.file_stats;
                const procStats = data.processing_stats;
                
                document.getElementById('totalSize').textContent = `${fileStats.total_size_gb.toFixed(1)} GB`;
                document.getElementById('successRate').textContent = `${procStats.success_rate}%`;
            } catch (error) {
                console.error('Error fetching statistics:', error);
            }
        }

        async function refreshHistory() {
            try {
                const response = await fetch('/api/history?limit=15');
                const data = await response.json();
                
                const container = document.getElementById('recentActivity');
                container.innerHTML = '';
                
                if (data.history.length === 0) {
                    container.innerHTML = '<p class="p-4 text-gray-500">No processing history yet</p>';
                    return;
                }
                
                data.history.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'p-4 hover:bg-gray-50';
                    
                    const success = entry.success;
                    const statusClass = success ? 'text-green-600' : 'text-red-600';
                    const statusIcon = success ? '‚úì' : '‚úó';
                    
                    const videoName = entry.video_path.split('/').pop();
                    const timestamp = new Date(entry.timestamp).toLocaleString();
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="${statusClass} font-bold">${statusIcon}</span>
                                    <span class="font-medium">${videoName}</span>
                                </div>
                                <div class="text-sm text-gray-500 mt-1">${timestamp}</div>
                                ${entry.segments_muted ? `<div class="text-sm text-blue-600 mt-1">Segments muted: ${entry.segments_muted}</div>` : ''}
                                ${entry.error ? `<div class="text-sm text-red-600 mt-1">${entry.error}</div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error fetching history:', error);
            }
        }

        async function refreshFailures() {
            try {
                const response = await fetch('/api/failures');
                const data = await response.json();
                
                const container = document.getElementById('failedVideos');
                container.innerHTML = '';
                
                if (data.failures.length === 0) {
                    container.innerHTML = '<p class="p-4 text-gray-500">No failures! üéâ</p>';
                    return;
                }
                
                data.failures.slice(0, 15).forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'p-4 hover:bg-gray-50';
                    
                    const videoName = entry.video_path.split('/').pop();
                    const error = entry.error || 'Unknown error';
                    
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-red-600">${videoName}</div>
                            <div class="text-sm text-gray-600 mt-1">${error}</div>
                            <button 
                                onclick="retryVideo('${entry.video_path}')" 
                                class="mt-2 text-sm px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                            >
                                Retry
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error fetching failures:', error);
            }
        }

        let searchTimeout;
        async function searchVideos() {
            clearTimeout(searchTimeout);
            
            const query = document.getElementById('searchInput').value;
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    const container = document.getElementById('searchResults');
                    container.innerHTML = '';
                    
                    if (data.matches.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 p-2">No matches found</p>';
                        return;
                    }
                    
                    data.matches.forEach(path => {
                        const div = document.createElement('div');
                        div.className = 'p-2 hover:bg-blue-50 cursor-pointer rounded';
                        div.textContent = path.split('/').pop();
                        div.onclick = () => selectVideo(path);
                        container.appendChild(div);
                    });
                } catch (error) {
                    console.error('Error searching:', error);
                }
            }, 300);
        }

        function selectVideo(path) {
            selectedVideoPath = path;
            document.getElementById('searchInput').value = path.split('/').pop();
            document.getElementById('searchResults').innerHTML = '';
        }

        async function processSelected() {
            if (!selectedVideoPath) {
                alert('Please search and select a video first');
                return;
            }
            
            if (!confirm(`Process ${selectedVideoPath.split('/').pop()}?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_path: selectedVideoPath
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Processing started! Check Recent Activity for updates.');
                    refreshHistory();
                    selectedVideoPath = null;
                    document.getElementById('searchInput').value = '';
                } else {
                    alert('Error: ' + (data.error || 'Processing failed'));
                }
            } catch (error) {
                alert('Error processing video: ' + error.message);
            }
        }

        async function retryVideo(videoPath) {
            if (!confirm(`Retry ${videoPath.split('/').pop()}?`)) {
                return;
            }
            
            try {
                // First reset it
                await fetch('/api/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ video_path: videoPath })
                });
                
                // Then process it
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ video_path: videoPath })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Retry started! Check Recent Activity for updates.');
                    refreshHistory();
                    refreshFailures();
                } else {
                    alert('Error: ' + (data.error || 'Retry failed'));
                }
            } catch (error) {
                alert('Error retrying video: ' + error.message);
            }
        }
    </script>
</body>
</html>
